<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Mazmorras</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            background-color: #222;
            color: #fff;
            text-align: center;
            font-family: Arial, sans-serif;
        }

        canvas {
            image-rendering: pixelated;
            margin-top: 20px;
        }

        .buttons {
            margin-top: 20px;
        }

        button {
            padding: 8px 16px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #level-name {
            margin-top: 10px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§­ Generador de Mazmorras</h1>

    <div id="level-name">Nivel {{ nivel }}</div>

    <canvas id="mapCanvas" width="1024" height="1024"></canvas>

    <div class="buttons">
        <a href="/?nivel={{ nivel - 1 }}"><button>&larr; Anterior</button></a>
        <a href="/?nivel={{ nivel + 1 }}"><button>Siguiente &rarr;</button></a>
        <button onclick="guardarJSON()">ðŸ’¾ Guardar</button>
    </div>

    <script>
        const tiles = {{ tiles_json|safe }};
        const canvas = document.getElementById("mapCanvas");
        const ctx = canvas.getContext("2d");
        const tileSize = 512;

        const nivel = {{ nivel }};

        const images = {};
        const promises = [];

        for (const fila of tiles) {
            for (const tile of fila) {
                const tipo = tile.tipo;
                if (!images[tipo]) {
                    images[tipo] = new Image();
                    images[tipo].src = "/static/Tiles/" + tipo + ".png";
                    const p = new Promise(resolve => {
                        images[tipo].onload = resolve;
                    });
                    promises.push(p);
                }
            }
        }

        Promise.all(promises).then(() => {
            for (let y = 0; y < tiles.length; y++) {
                for (let x = 0; x < tiles[y].length; x++) {
                    const tipo = tiles[y][x].tipo;
                    ctx.drawImage(images[tipo], x * tileSize, y * tileSize, tileSize, tileSize);
                }
            }
        });

        function guardarJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tiles, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "mazmorra_nivel_" + nivel + ".json");
            document.body.appendChild(dlAnchor);
            dlAnchor.click();
            dlAnchor.remove();
        }
    </script>
</body>
</html>