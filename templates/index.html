<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Mazmorras</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    canvas {
      background-color: #111;
      margin-top: 10px;
      image-rendering: pixelated;
      border: 2px solid #444;
    }

    .buttons {
      margin: 10px;
    }

    .buttons button,
    .buttons label {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      background-color: #333;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .buttons input[type="file"] {
      display: none;
    }

    .buttons button:hover,
    .buttons label:hover {
      background-color: #555;
    }
  </style>
</head>
<body>
  <h1>Nivel {{ nivel }}</h1>

  <div class="buttons">
    <a href="/?nivel={{ nivel - 1 }}"><button>&larr; Anterior</button></a>
    <a href="/?nivel={{ nivel + 1 }}"><button>Siguiente &rarr;</button></a>
    <button onclick="guardarJSON()">ðŸ’¾ Guardar</button>
    <button onclick="guardarPNG()">ðŸ–¼ Guardar PNG</button>
    <label for="fileInput">ðŸ“‚ Cargar JSON</label>
    <input type="file" id="fileInput" accept=".json" />
  </div>

  <canvas id="canvas" width="2048" height="2048"></canvas>

  <script>
    const nivel = {{ nivel }};
    const mapa = {{ mapa | tojson }};
    const tileSize = 512;
    const tileImages = {};
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const tileMap = {
      "bosque": "static/tiles/Bosque.png",
      "cueva": "static/tiles/Cueva.png",
      "lava": "static/tiles/Lava.png",
      "agua": "static/tiles/Agua.png",
      "piedra": "static/tiles/Piedra.png",
      "jungla": "static/tiles/Jungla.png",
      "nieve": "static/tiles/Nieve.png",
      "desierto": "static/tiles/Desierto.png",
      "pantano": "static/tiles/Pantano.png",
      "ciudad": "static/tiles/Ciudad.png",
      "boss": "static/tiles/Boss.png",
      "campamento": "static/tiles/Campamento.png"
    };

    function cargarImagen(nombre, src) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve({ nombre, img });
        img.src = src;
      });
    }

    async function cargarTodasLasImagenes() {
      const promesas = Object.entries(tileMap).map(([nombre, src]) => cargarImagen(nombre, src));
      const resultados = await Promise.all(promesas);
      resultados.forEach(({ nombre, img }) => {
        tileImages[nombre] = img;
      });
      dibujarMapa();
    }

    function dibujarMapa() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const offsetX = canvas.width / 2;
      const offsetY = 100;

      for (let y = 0; y < mapa.length; y++) {
        for (let x = 0; x < mapa[y].length; x++) {
          const tipo = mapa[y][x];
          const img = tileImages[tipo];
          if (!img) continue;

          const isoX = (x - y) * (tileSize / 2) + offsetX;
          const isoY = (x + y) * (tileSize / 4) + offsetY;

          ctx.drawImage(img, isoX, isoY, tileSize, tileSize);
        }
      }
    }

    function guardarJSON() {
      const blob = new Blob([JSON.stringify(mapa)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nivel_" + nivel + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function guardarPNG() {
      const link = document.createElement('a');
      link.download = "mazmorra_nivel_" + nivel + ".png";
      link.href = canvas.toDataURL("image/png");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const nuevoMapa = JSON.parse(e.target.result);
        for (let y = 0; y < nuevoMapa.length; y++) {
          for (let x = 0; x < nuevoMapa[y].length; x++) {
            mapa[y][x] = nuevoMapa[y][x];
          }
        }
        dibujarMapa();
      };
      reader.readAsText(file);
    });

    cargarTodasLasImagenes();
  </script>
</body>
</html>